generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  USER
}

enum TeamJoinRequestStatus {
  PENDING
  ACCEPTED
  REJECTED
}

model User {
  id                String            @id @default(cuid())
  email             String            @unique
  name              String?
  nickname          String?           @unique
  avatar            String?
  teamId            String?
  passwordHash      String?
  role              UserRole          @default(USER)
  team              Team?             @relation("TeamMembers", fields: [teamId], references: [id], onDelete: SetNull)
  ledTeam           Team?             @relation("TeamLeader")
  teamJoinRequests  TeamJoinRequest[]
  claims            DistrictClaim[]
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([teamId])
}

model Team {
  id               String            @id @default(cuid())
  name             String
  slug             String            @unique
  leaderUserId     String
  leader           User              @relation("TeamLeader", fields: [leaderUserId], references: [id], onDelete: Cascade)
  users            User[]            @relation("TeamMembers")
  joinRequests     TeamJoinRequest[]
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  @@unique([leaderUserId])
  @@index([leaderUserId])
}

model TeamJoinRequest {
  id         String                @id @default(cuid())
  teamId     String
  userId     String
  status     TeamJoinRequestStatus @default(PENDING)
  createdAt  DateTime              @default(now())
  updatedAt  DateTime              @updatedAt
  respondedAt DateTime?
  team       Team                  @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user       User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId, status])
  @@index([userId, status])
}

model DistrictClaim {
  id                String   @id @default(cuid())
  userId            String
  districtCode      String
  chapterSlug       String
  districtName      String
  selfieUrl         String
  signVisible       Boolean  @default(true)
  claimedAt         DateTime @default(now())
  basePoints        Int
  sameDayMultiplier Float
  streakBonus       Int
  awardedPoints     Int
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, districtCode])
  @@index([userId, claimedAt])
}
